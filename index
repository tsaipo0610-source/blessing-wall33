<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>校長會議 / 16:9 投影專用版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;700&family=Noto+Sans+TC:wght@300;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-gold: #E5C07B;
            --dark-gold: #B8860B;
            --deep-navy: #0A0F1E;
            --glass-bg: rgba(10, 15, 30, 0.85);
            --heart-red: #FF4D4D;
        }

        body { 
            font-family: 'Montserrat', 'Noto Sans TC', sans-serif; 
            background: radial-gradient(circle at 50% 50%, #162447 0%, #0A0F1E 100%); 
            color: #F1F5F9; 
            margin: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            overflow: hidden; 
        }

        .projection-canvas {
            width: 100vw;
            height: 56.25vw; 
            max-height: 100vh;
            max-width: 177.78vh; 
            position: relative;
            display: flex;
            flex-direction: column;
            padding: 4% 6%;
            box-sizing: border-box;
            z-index: 10;
        }

        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            border: 1px solid rgba(229, 192, 123, 0.2);
            box-shadow: 0 20px 60px 0 rgba(0, 0, 0, 0.9);
        }

        .title-line-1 { 
            font-size: 1.8vw; 
            font-weight: 300; 
            letter-spacing: 2.2em; 
            color: var(--primary-gold);
            text-indent: 2.2em;
            text-shadow: 0 0 25px rgba(229, 192, 123, 0.7);
            white-space: nowrap;
        }
        .title-line-2 { 
            font-size: 3.5vw; 
            font-weight: 700; 
            letter-spacing: 0.3em; 
            color: #FFFFFF;
            border-top: 2px solid rgba(229, 192, 123, 0.5); 
            padding-top: 1rem;
            text-shadow: 0 10px 30px rgba(0, 0, 0, 0.8);
            white-space: nowrap;
            text-indent: 0.3em;
        }

        .nav-btn, .lang-btn { 
            background-color: rgba(255, 255, 255, 0.05);
            color: #94A3B8; 
            transition: all 0.4s ease;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .nav-btn.active, .lang-btn.active { 
            background: linear-gradient(135deg, var(--primary-gold) 0%, var(--dark-gold) 100%);
            color: #0A0F1E; 
            border-color: var(--primary-gold);
        }

        .submit-btn { 
            background: linear-gradient(135deg, #E5C07B 0%, #B8860B 100%);
            color: #0A0F1E; 
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.2em;
            box-shadow: 0 0 30px rgba(229, 192, 123, 0.4);
        }

        .event-heart-btn {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(229, 192, 123, 0.3);
            border-radius: 100px;
            padding: 0.8vw 2.5vw;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 1vw;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            width: 100%;
        }
        .event-heart-btn:hover:not(.is-liked) {
            border-color: var(--primary-gold);
            background: rgba(229, 192, 123, 0.1);
            transform: translateY(-3px);
        }
        .event-heart-btn.is-liked {
            border-color: var(--heart-red);
            background: rgba(255, 77, 77, 0.15);
            cursor: default;
        }
        .event-heart-btn.is-liked svg { fill: var(--heart-red); stroke: var(--heart-red); }
        .event-heart-btn.is-liked span { color: var(--heart-red); }

        .blessing-card { 
            display: inline-flex; 
            flex-direction: column;
            margin: 0 2rem; 
            background: linear-gradient(135deg, rgba(255,255,255,0.12) 0%, rgba(255,255,255,0.03) 100%);
            padding: 2vw 3vw; 
            border-radius: 20px; 
            border-left: 8px solid var(--primary-gold);
            min-width: 25vw;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.4);
        }
        .blessing-card .message { font-size: 1.8vw; color: #FFF; margin-bottom: 1rem; font-weight: 500; line-height: 1.4; }
        .blessing-card .info { color: var(--primary-gold); font-size: 1.1vw; letter-spacing: 0.1em; opacity: 0.9; }
        
        @keyframes marquee { 0% { transform: translateX(0); } 100% { transform: translateX(-100%); } }
        .marquee-content { display: inline-block; animation: marquee 100s linear infinite; }

        .particle {
            position: absolute;
            background: radial-gradient(circle, #E5C07B 0%, transparent 70%);
            border-radius: 50%;
            pointer-events: none;
            opacity: 0.3;
            animation: float linear infinite;
        }

        @keyframes float {
            0% { transform: translateY(0) translateX(0); opacity: 0; }
            50% { opacity: 0.5; }
            100% { transform: translateY(-100vh) translateX(30px); opacity: 0; }
        }

        input, textarea {
            background: rgba(255, 255, 255, 0.05) !important;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
            transition: all 0.3s ease;
        }
        input:focus, textarea:focus {
            border-color: var(--primary-gold) !important;
            background: rgba(255, 255, 255, 0.08) !important;
            box-shadow: 0 0 15px rgba(229, 192, 123, 0.2);
        }

        .wall-stats {
            background: rgba(229, 192, 123, 0.1);
            border: 1px solid rgba(229, 192, 123, 0.3);
            padding: 1vw 3vw;
            border-radius: 100px;
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            gap: 1.5vw;
            margin-top: 4vw;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.3);
        }
    </style>
</head>
<body>

    <div id="particle-container" class="absolute inset-0 z-0"></div>

    <div class="projection-canvas">
        <div class="absolute top-8 right-12 z-50 flex gap-4 scale-90 origin-right">
            <div class="flex space-x-1 p-1 bg-white/5 backdrop-blur-md rounded-lg border border-white/10">
                <button id="show-input-btn" class="nav-btn px-6 py-2 text-sm font-semibold rounded-md"></button>
                <button id="show-display-btn" class="nav-btn px-6 py-2 text-sm font-semibold rounded-md"></button>
            </div>
            <div class="flex space-x-1 p-1 bg-white/5 backdrop-blur-md rounded-lg border border-white/10">
                <button id="lang-zh-btn" class="lang-btn px-4 py-2 text-sm font-semibold rounded-md">繁中</button>
                <button id="lang-en-btn" class="lang-btn px-4 py-2 text-sm font-semibold rounded-md">EN</button>
            </div>
        </div>

        <div class="flex flex-col h-full">
            <header class="mb-12">
                <div id="event-title-sub" class="title-line-1"></div>
                <h1 id="event-title-main" class="title-line-2"></h1>
            </header>

            <main class="flex-grow relative z-10 flex items-center justify-center">
                <!-- 簽到輸入區 -->
                <section id="input-section" class="w-full grid grid-cols-1 lg:grid-cols-5 gap-12 transition-all duration-700">
                    <div class="lg:col-span-2 flex flex-col justify-center space-y-6">
                        <div class="glass-panel p-10 rounded-3xl border-l-8 border-l-[#E5C07B] flex flex-col justify-between h-full">
                            <div>
                                <h2 id="form-title" class="text-3xl font-light mb-4 tracking-[0.3em] text-white"></h2>
                                <p class="text-gray-400 font-light leading-relaxed mb-8">歡迎各位教育領袖蒞臨。<br>請在此留下您的寶貴足跡與對教育未來的期許。</p>
                            </div>
                            
                            <div class="border-t border-white/10 pt-8">
                                <p id="heart-cta" class="text-xs text-gray-500 uppercase tracking-[0.2em] mb-4"></p>
                                <button type="button" id="event-like-btn" class="event-heart-btn group">
                                    <svg class="w-8 h-8 stroke-white/40 fill-none transition-all group-hover:scale-110" viewBox="0 0 24 24" stroke-width="1.5">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M21 8.25c0-2.485-2.099-4.5-4.688-4.5-1.935 0-3.597 1.126-4.312 2.733-.715-1.607-2.377-2.733-4.313-2.733C5.1 3.75 3 5.765 3 8.25c0 7.22 9 12 9 12s9-4.78 9-12z" />
                                    </svg>
                                    <span id="like-btn-text" class="text-xl font-bold text-white/80 tracking-widest uppercase"></span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="lg:col-span-3">
                        <div class="glass-panel p-10 rounded-3xl">
                            <form id="guest-form" class="space-y-6">
                                <div class="grid grid-cols-2 gap-6">
                                    <div class="space-y-2">
                                        <label id="label-name" class="text-xs text-gray-400 font-semibold uppercase tracking-widest ml-1"></label>
                                        <input type="text" id="name" required class="w-full rounded-xl px-5 py-4 text-white focus:outline-none text-lg">
                                    </div>
                                    <div class="space-y-2">
                                        <label id="label-org" class="text-xs text-gray-400 font-semibold uppercase tracking-widest ml-1"></label>
                                        <input type="text" id="organization" required class="w-full rounded-xl px-5 py-4 text-white focus:outline-none text-lg">
                                    </div>
                                </div>
                                <div class="space-y-2">
                                    <label id="label-title" class="text-xs text-gray-400 font-semibold uppercase tracking-widest ml-1"></label>
                                    <input type="text" id="title-field" required class="w-full rounded-xl px-5 py-4 text-white focus:outline-none text-lg">
                                </div>
                                <div class="relative space-y-2">
                                    <div class="flex justify-between items-center px-1">
                                        <label id="label-blessing" class="text-xs text-gray-400 font-semibold uppercase tracking-widest"></label>
                                        <button type="button" id="ai-btn" class="text-xs font-bold text-[#38BDF8] hover:text-[#E5C07B] flex items-center gap-1 transition-all uppercase tracking-widest">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>
                                            <span id="btn-ai-text"></span>
                                        </button>
                                    </div>
                                    <textarea id="blessing" rows="3" maxlength="100" required class="w-full rounded-xl px-5 py-4 text-white focus:outline-none resize-none text-lg"></textarea>
                                    <div id="ai-loader" class="absolute inset-0 bg-black/60 backdrop-blur-sm rounded-xl flex items-center justify-center hidden">
                                        <div class="w-8 h-8 border-4 border-white/20 border-t-[#E5C07B] animate-spin rounded-full"></div>
                                    </div>
                                </div>
                                <button type="submit" id="submit-btn" class="submit-btn w-full py-5 rounded-xl flex items-center justify-center gap-3 text-xl">
                                    <span id="submit-text"></span>
                                    <div id="submit-loader" class="animate-spin rounded-full h-6 w-6 border-2 border-white/30 border-t-white hidden"></div>
                                </button>
                            </form>
                        </div>
                    </div>
                </section>

                <!-- 展示區 -->
                <section id="display-section" class="hidden w-full h-full flex flex-col items-center justify-center">
                    <div id="no-blessings" class="text-center opacity-30">
                        <p id="placeholder-text" class="text-4xl font-light tracking-widest italic"></p>
                    </div>
                    <div id="marquee-wall" class="w-screen space-y-12 overflow-hidden hidden flex flex-col items-center">
                        <div class="marquee-container w-full overflow-hidden"><div id="m-row-1" class="marquee-content"></div></div>
                        <div class="marquee-container w-full overflow-hidden"><div id="m-row-2" class="marquee-content"></div></div>
                        
                        <div class="wall-stats">
                            <svg class="w-10 h-10 fill-[#FF4D4D]" viewBox="0 0 24 24">
                                <path d="M21 8.25c0-2.485-2.099-4.5-4.688-4.5-1.935 0-3.597 1.126-4.312 2.733-.715-1.607-2.377-2.733-4.313-2.733C5.1 3.75 3 5.765 3 8.25c0 7.22 9 12 9 12s9-4.78 9-12z" />
                            </svg>
                            <div class="flex flex-col">
                                <span id="wall-stats-label" class="text-[0.7vw] uppercase tracking-[0.3em] text-white/50"></span>
                                <span id="total-likes" class="text-4xl font-bold text-white tabular-nums leading-none">0</span>
                            </div>
                        </div>
                    </div>
                </section>
            </main>
        </div>
    </div>

    <!-- 彈窗 -->
    <div id="status-modal" class="fixed inset-0 bg-black/90 backdrop-blur-xl flex items-center justify-center opacity-0 pointer-events-none transition-all z-[100]">
        <div class="glass-panel p-16 rounded-[40px] max-w-lg w-full text-center scale-90">
            <div id="modal-icon" class="w-24 h-24 rounded-full flex items-center justify-center mx-auto mb-8 bg-white/5 border border-white/10"></div>
            <h3 id="modal-title" class="text-4xl font-bold text-white mb-4"></h3>
            <p id="modal-msg" class="text-xl text-gray-400 mb-10 font-light"></p>
            <button onclick="closeModal()" class="w-full py-5 bg-white/10 hover:bg-white/20 text-white text-xl font-semibold rounded-2xl transition-all border border-white/10">CLOSE</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, serverTimestamp, query, doc, updateDoc, increment, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase & ID 設定
        const apiKey = ""; 
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'principal-conf-169';
        
        // --- 核心設定：Google Apps Script 部署網址 ---
        const googleSheetUrl = "https://script.google.com/macros/s/AKfycbx1YM1jFCg4bnjYn3hOFWjVOnDHy8TDLvoKZmHIYW5T6iX3OnM_qbAf3shkpkoKS52p/exec"; 
        
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let currentLang = localStorage.getItem('guest_lang_v3') || 'zh';
        let hasLikedEvent = localStorage.getItem('event_liked_' + appId) === 'true';

        const i18n = {
            zh: {
                titleSub: "校長會議",
                titleMain: "貴賓簽到與祝福",
                navInput: "簽到註冊",
                navDisplay: "祝福牆專區",
                signInTitle: "GUEST REGISTRATION",
                labelName: "姓名 / Name",
                labelOrg: "服務單位 / Organization",
                labelTitle: "職稱 / Position",
                labelBlessing: "祝福辭 / Message",
                aiButton: "AI 智繪祝福",
                submitBtn: "提交簽到訊息",
                submitting: "正在傳送...",
                blessingPlaceholder: "凝聚智慧，共創卓越 — 期待您的暖心留言",
                successTitle: "提交成功",
                successMsg: "您的蒞臨與祝福已載入系統並同步至後端資料庫與試算表。",
                heartCta: "為會議點亮卓越能量",
                likeBtn: "支持活動",
                likedBtn: "感謝支持",
                wallStatsLabel: "累計教育正能量",
                errorTitle: "傳輸中斷",
                aiPrompt: "你是一個專業的教育研討會禮賓專家。請根據以下資訊：姓名：{name}、單位：{org}、職稱：{title}，生成一段約 25-30 字的繁體中文優雅祝福語，語氣需溫馨且具備前瞻教育視野。只需返回文字，不要包含任何標籤或引號。"
            },
            en: {
                titleSub: "PRINCIPAL CONFERENCE",
                titleMain: "GUEST WELCOME & BLESSING",
                navInput: "Register",
                navDisplay: "Blessing Wall",
                signInTitle: "Guest Registration",
                labelName: "Full Name",
                labelOrg: "Organization",
                labelTitle: "Position / Title",
                labelBlessing: "Blessing Message",
                aiButton: "AI Assist",
                submitBtn: "Submit Entry",
                submitting: "Sending...",
                blessingPlaceholder: "Waiting for your distinguished contribution...",
                successTitle: "Success",
                successMsg: "Welcome. Data has been synced to the registry.",
                heartCta: "SUPPORT THIS EVENT",
                likeBtn: "LIKE EVENT",
                likedBtn: "SUPPORTED",
                wallStatsLabel: "ACCUMULATED ENERGY",
                errorTitle: "Error",
                aiPrompt: "Professional educational conference concierge. Generate an elegant 15-20 word English blessing for: Name: {name}, Org: {org}, Title: {title}. Focus on educational leadership and future vision. Return ONLY the text."
            }
        };

        function updateUI() {
            const t = i18n[currentLang];
            document.getElementById('event-title-sub').innerText = t.titleSub;
            document.getElementById('event-title-main').innerText = t.titleMain;
            document.getElementById('show-input-btn').innerText = t.navInput;
            document.getElementById('show-display-btn').innerText = t.navDisplay;
            document.getElementById('form-title').innerText = t.signInTitle;
            document.getElementById('label-name').innerText = t.labelName;
            document.getElementById('label-org').innerText = t.labelOrg;
            document.getElementById('label-title').innerText = t.labelTitle;
            document.getElementById('label-blessing').innerText = t.labelBlessing;
            document.getElementById('btn-ai-text').innerText = t.aiButton;
            document.getElementById('submit-text').innerText = t.submitBtn;
            document.getElementById('placeholder-text').innerText = t.blessingPlaceholder;
            document.getElementById('heart-cta').innerText = t.heartCta;
            document.getElementById('like-btn-text').innerText = hasLikedEvent ? t.likedBtn : t.likeBtn;
            document.getElementById('wall-stats-label').innerText = t.wallStatsLabel;

            document.getElementById('lang-zh-btn').classList.toggle('active', currentLang === 'zh');
            document.getElementById('lang-en-btn').classList.toggle('active', currentLang === 'en');
            
            const likeBtn = document.getElementById('event-like-btn');
            if (hasLikedEvent) {
                likeBtn.classList.add('is-liked');
            } else {
                likeBtn.classList.remove('is-liked');
            }
        }

        function toggleSection(section) {
            const input = document.getElementById('input-section');
            const display = document.getElementById('display-section');
            const inputBtn = document.getElementById('show-input-btn');
            const displayBtn = document.getElementById('show-display-btn');

            if (section === 'input') {
                input.classList.remove('hidden');
                display.classList.add('hidden');
                inputBtn.classList.add('active');
                displayBtn.classList.remove('active');
            } else {
                input.classList.add('hidden');
                display.classList.remove('hidden');
                inputBtn.classList.remove('active');
                displayBtn.classList.add('active');
            }
        }

        window.closeModal = () => {
            const modal = document.getElementById('status-modal');
            modal.classList.add('opacity-0', 'pointer-events-none');
        };

        function showModal(type, title, msg) {
            const modal = document.getElementById('status-modal');
            const icon = document.getElementById('modal-icon');
            document.getElementById('modal-title').innerText = title;
            document.getElementById('modal-msg').innerText = msg;
            
            icon.innerHTML = type === 'success' 
                ? `<svg class="h-16 w-16 text-[#E5C07B]" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7" /></svg>`
                : `<svg class="h-16 w-16 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M6 18L18 6M6 6l12 12" /></svg>`;
            
            modal.classList.remove('opacity-0', 'pointer-events-none');
        }

        async function initApp() {
            const initAuth = async () => {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            };
            
            await initAuth();

            onAuthStateChanged(auth, (user) => {
                currentUser = user;
                if (user) {
                    listenForBlessings();
                    listenForEventLikes();
                }
            });

            document.getElementById('lang-zh-btn').onclick = () => { currentLang = 'zh'; localStorage.setItem('guest_lang_v3', 'zh'); updateUI(); };
            document.getElementById('lang-en-btn').onclick = () => { currentLang = 'en'; localStorage.setItem('guest_lang_v3', 'en'); updateUI(); };
            document.getElementById('show-input-btn').onclick = () => toggleSection('input');
            document.getElementById('show-display-btn').onclick = () => toggleSection('display');
            document.getElementById('ai-btn').onclick = generateAI;
            document.getElementById('event-like-btn').onclick = handleEventLike;
            
            document.getElementById('guest-form').onsubmit = async (e) => {
                e.preventDefault();
                if (!currentUser) return;

                const submitBtn = document.getElementById('submit-btn');
                const submitText = document.getElementById('submit-text');
                const submitLoader = document.getElementById('submit-loader');

                const data = {
                    name: document.getElementById('name').value,
                    organization: document.getElementById('organization').value,
                    title: document.getElementById('title-field').value,
                    blessing: document.getElementById('blessing').value
                };

                submitBtn.disabled = true;
                submitText.innerText = i18n[currentLang].submitting;
                submitLoader.classList.remove('hidden');

                try {
                    // 1. 同步到 Firestore
                    const publicCol = collection(db, 'artifacts', appId, 'public', 'data', 'blessings');
                    await addDoc(publicCol, { ...data, timestamp: serverTimestamp() });

                    // 2. 同步到 Google Sheet (GAS)
                    await fetch(googleSheetUrl, {
                        method: 'POST',
                        mode: 'no-cors',
                        cache: 'no-cache',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });

                    showModal('success', i18n[currentLang].successTitle, i18n[currentLang].successMsg);
                    document.getElementById('guest-form').reset();
                    setTimeout(() => toggleSection('display'), 2500);
                } catch (err) {
                    console.error("Submit Error:", err);
                    showModal('error', i18n[currentLang].errorTitle, "資料傳送失敗，請確認網路或腳本設置。");
                } finally {
                    submitBtn.disabled = false;
                    submitText.innerText = i18n[currentLang].submitBtn;
                    submitLoader.classList.add('hidden');
                }
            };

            updateUI();
            createParticles();
        }

        async function listenForEventLikes() {
            const statsDoc = doc(db, 'artifacts', appId, 'public', 'data', 'stats', 'global');
            onSnapshot(statsDoc, (docSnap) => {
                if (docSnap.exists()) {
                    document.getElementById('total-likes').innerText = docSnap.data().likes || 0;
                } else {
                    setDoc(statsDoc, { likes: 0 });
                }
            }, (err) => console.error("Stats error:", err));
        }

        async function handleEventLike() {
            if (hasLikedEvent || !currentUser) return;
            hasLikedEvent = true;
            localStorage.setItem('event_liked_' + appId, 'true');
            const likeBtn = document.getElementById('event-like-btn');
            likeBtn.classList.add('is-liked');
            document.getElementById('like-btn-text').innerText = i18n[currentLang].likedBtn;

            try {
                const statsDoc = doc(db, 'artifacts', appId, 'public', 'data', 'stats', 'global');
                await updateDoc(statsDoc, { likes: increment(1) });
            } catch (err) {
                hasLikedEvent = false;
                localStorage.removeItem('event_liked_' + appId);
                likeBtn.classList.remove('is-liked');
                document.getElementById('like-btn-text').innerText = i18n[currentLang].likeBtn;
            }
        }

        async function generateAI() {
            const name = document.getElementById('name').value;
            const org = document.getElementById('organization').value;
            const title = document.getElementById('title-field').value;
            
            if (!name || !org) {
                return showModal('error', '資訊不完整', '請至少輸入姓名與單位。');
            }

            const loader = document.getElementById('ai-loader');
            loader.classList.remove('hidden');
            
            const promptText = i18n[currentLang].aiPrompt
                .replace('{name}', name)
                .replace('{org}', org)
                .replace('{title}', title || '領袖');

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: promptText }] }]
                    })
                });
                
                const resData = await response.json();
                const aiText = resData.candidates?.[0]?.content?.parts?.[0]?.text?.trim();
                if (aiText) {
                    document.getElementById('blessing').value = aiText;
                }
            } catch (err) {
                showModal('error', 'AI 忙碌中', '請手動輸入祝福語。');
            } finally {
                loader.classList.add('hidden');
            }
        }

        function listenForBlessings() {
            const publicCol = collection(db, 'artifacts', appId, 'public', 'data', 'blessings');
            onSnapshot(publicCol, (snapshot) => {
                const docs = snapshot.docs.map(d => d.data()).filter(d => d.blessing);
                renderWall(docs);
            }, (err) => console.error(err));
        }

        function renderWall(docs) {
            const wall = document.getElementById('marquee-wall');
            const placeholder = document.getElementById('no-blessings');
            if (docs.length === 0) {
                wall.classList.add('hidden');
                placeholder.classList.remove('hidden');
                return;
            }
            wall.classList.remove('hidden');
            placeholder.classList.add('hidden');
            
            const rows = [document.getElementById('m-row-1'), document.getElementById('m-row-2')];
            rows.forEach(r => r.innerHTML = '');
            
            docs.forEach((d, index) => {
                const card = document.createElement('div');
                card.className = 'blessing-card';
                card.innerHTML = `<div class="message">"${d.blessing}"</div><div class="info">${d.name} | ${d.organization} ${d.title}</div>`;
                rows[index % 2].appendChild(card);
            });
            
            if (docs.length > 0) {
                rows.forEach(r => {
                    const clone = r.innerHTML;
                    r.innerHTML += clone + clone; 
                });
            }
        }

        function createParticles() {
            const container = document.getElementById('particle-container');
            for (let i = 0; i < 40; i++) {
                const p = document.createElement('div');
                p.className = 'particle';
                const size = Math.random() * 5 + 3;
                p.style.width = `${size}px`;
                p.style.height = `${size}px`;
                p.style.left = `${Math.random() * 100}%`;
                p.style.top = `${Math.random() * 100}%`;
                p.style.animationDuration = `${Math.random() * 20 + 15}s`;
                p.style.animationDelay = `${Math.random() * 10}s`;
                container.appendChild(p);
            }
        }
        window.onload = initApp;
    </script>
</body>
</html>
